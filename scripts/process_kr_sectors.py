import pandas as pd
import os

# íŒŒì¼ ê²½ë¡œ
data_dir = r"C:\Users\ws\Desktop\Python\Project_Hermes5\data"
file_path = os.path.join(data_dir, 'kr_stock_sectors.csv')

# CSV ë¡œë“œ
df = pd.read_csv(file_path, encoding='utf-8-sig')

# NaNì„ 'N/A' ë¬¸ìì—´ë¡œ ë³€í™˜
df['ì—…ì¢…'] = df['ì—…ì¢…'].fillna('N/A')

print(f"ì´ {len(df)}ê°œ ì¢…ëª©")
print(f"ì—…ì¢… N/A: {len(df[df['ì—…ì¢…'] == 'N/A'])}ê°œ")

# ============================================
# 1. N/A ì¢…ëª© ì¤‘ ë¦¬ì¸ /ì¸í”„ë¼ ì²˜ë¦¬
# ============================================
print("\n[ë¦¬ì¸ /ì¸í”„ë¼ ì¢…ëª© ì²˜ë¦¬]")
rits_infra = df[df['íšŒì‚¬ëª…'].str.contains('ë¦¬ì¸ |ì¸í”„ë¼', na=False)]
print(f"ë¦¬ì¸ /ì¸í”„ë¼ ì¢…ëª©: {len(rits_infra)}ê°œ")
for idx, row in rits_infra.iterrows():
    print(f"  {row['íšŒì‚¬ëª…']:30s} ì—…ì¢…: {row['ì—…ì¢…']}")

def classify_na_sector(row):
    """N/A ì¢…ëª©ì˜ ì—…ì¢… ë¶„ë¥˜"""
    if row['ì—…ì¢…'] != 'N/A':
        return row['ì—…ì¢…']
    
    name = row['íšŒì‚¬ëª…']
    
    # ë¦¬ì¸ ì™€ ì¸í”„ë¼ ë‘˜ ë‹¤ í¬í•¨ â†’ ë§ˆì§€ë§‰ ë‹¨ì–´ ê¸°ì¤€
    if 'ë¦¬ì¸ ' in name and 'ì¸í”„ë¼' in name:
        if name.endswith('ë¦¬ì¸ '):
            return 'ë¶€ë™ì‚°'
        elif name.endswith('ì¸í”„ë¼'):
            return 'ê¸ˆìœµ'
    
    # ë¦¬ì¸ ë§Œ í¬í•¨
    if 'ë¦¬ì¸ ' in name:
        return 'ë¶€ë™ì‚°'
    
    # ì¸í”„ë¼ë§Œ í¬í•¨
    if 'ì¸í”„ë¼' in name:
        return 'ê¸ˆìœµ'
    
    # ë§µìŠ¤ë¦¬ì–¼í‹° (ë¶€ë™ì‚°)
    if 'ë¦¬ì–¼í‹°' in name or 'ë§µìŠ¤ë¦¬ì–¼í‹°' in name:
        return 'ë¶€ë™ì‚°'
    
    return 'N/A'

df['ì—…ì¢…'] = df.apply(classify_na_sector, axis=1)

print(f"\nì²˜ë¦¬ í›„:")
for idx, row in rits_infra.iterrows():
    current_upjong = df.loc[idx, 'ì—…ì¢…']
    print(f"  {row['íšŒì‚¬ëª…']:30s} ì—…ì¢…: {current_upjong}")

print(f"\nì²˜ë¦¬ í›„ ì—…ì¢… N/A: {len(df[df['ì—…ì¢…'] == 'N/A'])}ê°œ")

# ============================================
# 2. ì—…ì¢… â†’ Sector ë§¤í•‘
# ============================================

# 11ê°œ ì„¹í„° ì •ì˜
sectors = {
    'Information Technology': [
        'ì†Œí”„íŠ¸ì›¨ì–´', 'ì»´í“¨í„°', 'ë°˜ë„ì²´', 'ì „ìë¶€í’ˆ', 'í†µì‹ ì¥ë¹„', 'ì „ìì¥ë¹„',
        'ì‚¬ì§„ì¥ë¹„', 'ê´‘í•™', 'ITì„œë¹„ìŠ¤', 'ì‹œìŠ¤í…œí†µí•©', 'ìë£Œì²˜ë¦¬', 'í˜¸ìŠ¤íŒ…',
        'í¬í„¸', 'ì¸í„°ë„·', 'ì •ë³´ì„œë¹„ìŠ¤', 'ë§ˆê·¸ë„¤í‹±', 'ê´‘í•™ë§¤ì²´', 'ì¸¡ì •', 'ì‹œí—˜',
        'í•­í•´', 'ì œì–´', 'ì •ë°€ê¸°ê¸°', 'ë””ìŠ¤í”Œë ˆì´ì¥ë¹„', 'ë””ìŠ¤í”Œë ˆì´íŒ¨ë„', 'í•¸ë“œì…‹',
        'ì „ìì œí’ˆ', 'ì‚¬ë¬´ìš©ì „ìì œí’ˆ'
    ],
    'Consumer Discretionary': [
        'ë´‰ì œ', 'ì˜ë³µ', 'ì‹ ë°œ', 'ê°€ì£½', 'ê°€êµ¬', 'ìë™ì°¨', 'ìŠ¤í¬ì¸ ', 'ìœ ì›ì§€',
        'ì˜¤ë½', 'ì—¬í–‰', 'ì°½ì‘', 'ì˜ˆìˆ ', 'ì˜í™”', 'ë¹„ë””ì˜¤', 'ë°©ì†¡', 'ì˜¤ë””ì˜¤',
        'ê°€ì •ìš©ê¸°ê¸°', 'ì•¡ì„¸ì„œë¦¬', 'ìš´ë™', 'ê²½ê¸°ìš©êµ¬', 'ì„¬ìœ ', 'ì•…ê¸°', 'ê·€ê¸ˆì†',
        'ì¥ì‹ ìš©í’ˆ', 'í¸ì¡°', 'ê°€ë°©', 'ê°œì¸ìš©í’ˆ', 'ê°€ì •ìš©í’ˆ', 'ë¬´ì í¬ì†Œë§¤',
        'ìƒí’ˆì „ë¬¸ì†Œë§¤', 'ìƒí™œìš©í’ˆì†Œë§¤', 'ìŒì‹ë£Œí’ˆì†Œë§¤', 'ë‹´ë°°ì†Œë§¤', 'ë–¡',
        'ë¹µ', 'ê³¼ì', 'ì¢…í•©ì†Œë§¤', 'ê°€ì „ì œí’ˆì†Œë§¤', 'ì •ë³´í†µì‹ ì¥ë¹„ì†Œë§¤', 'ìˆ™ë°•',
        'ìŒì‹ì ', 'í˜¸í…”', 'ë ˆìŠ¤í† ë‘', 'ë ˆì €', 'ë°±í™”ì ', 'ì¼ë°˜ìƒì ',
        'í™”ì¥í’ˆ', 'íŒë§¤ì—…ì²´'
    ],
    'Communication Services': [
        'ì „ê¸°í†µì‹ ', 'í…”ë ˆë¹„ì „ë°©ì†¡', 'ê´‘ê³ ', 'ì˜ìƒ', 'ì„œì ', 'ì¡ì§€', 'ì¸ì‡„ë¬¼',
        'í…”ë ˆë¹„ì „', 'ê¸°ë¡ë§¤ì²´ë³µì œ', 'ì „ë¬¸ë””ìì¸', 'ì‹œì¥ì¡°ì‚¬', 'ì—¬ë¡ ì¡°ì‚¬',
        'ì–‘ë°©í–¥ë¯¸ë””ì–´', 'ê²Œì„ì—”í„°í…Œì¸ë¨¼íŠ¸', 'ë‹¤ê°í™”ëœí†µì‹ ', 'ë¬´ì„ í†µì‹ '
    ],
    'Health Care': [
        'ì˜ì•½í’ˆ', 'ì˜ë£Œìš©í’ˆ', 'ì˜ë£Œìš©ê¸°ê¸°', 'ê¸°ì´ˆì˜ì•½ë¬¼ì§ˆ', 'ìì—°ê³¼í•™',
        'ê³µí•™ì—°êµ¬', 'ê³¼í•™ê¸°ìˆ ', 'ì œì•½', 'ìƒë¬¼ê³µí•™', 'ê±´ê°•ê´€ë¦¬ì¥ë¹„', 'ê±´ê°•ê´€ë¦¬ì—…ì²´',
        'ê±´ê°•ê´€ë¦¬ê¸°ìˆ ', 'ìƒëª…ê³¼í•™ë„êµ¬', 'ìƒëª…ê³¼í•™'
    ],
    'Consumer Staples': [
        'ì‹í’ˆ', 'ê³¡ë¬¼', 'ì „ë¶„', 'ë™ë¬¼ì„±', 'ì‹ë¬¼ì„±', 'ìœ ì§€', 'ë‚™ë†', 'ê³¼ì‹¤',
        'ì±„ì†Œê°€ê³µ', 'ë„ì¶•', 'ìœ¡ë¥˜ê°€ê³µ', 'ìˆ˜ì‚°ë¬¼ê°€ê³µ', 'ì•Œì½”ì˜¬ìŒë£Œ', 'ë¹„ì•Œì½”ì˜¬ìŒë£Œ',
        'ë¹„ë£Œ', 'ë†ì•½', 'ë™ë¬¼ìš©ì‚¬ë£Œ', 'ë„ì‹œë½', 'ì¡°ë¦¬ì‹í’ˆ', 'ìŒë£Œ', 'ì‘ë¬¼ì¬ë°°',
        'ì–´ë¡œ', 'ì–´ì—…', 'ë‹´ë°°', 'ì‹í’ˆê³¼ê¸°ë³¸ì‹ë£Œí’ˆì†Œë§¤'
    ],
    'Financials': [
        'ê¸ˆìœµ', 'ì€í–‰', 'ì €ì¶•ê¸°ê´€', 'ë³´í—˜', 'ì‹ íƒ', 'ì§‘í•©íˆ¬ì', 'ê²½ì˜ì»¨ì„¤íŒ…',
        'ì¬ë³´í—˜', 'ì—°ê¸ˆ', 'ì¦ê¶Œ', 'ì°½ì—…íˆ¬ì', 'ì¹´ë“œ', 'ê¸°íƒ€ê¸ˆìœµ', 'ì†í•´ë³´í—˜',
        'ìƒëª…ë³´í—˜', 'ë¶€ë™ì‚°', 'ìì‚°ì‹ íƒ'
    ],
    'Energy': [
        'ê¸°ì´ˆí™”í•™ë¬¼ì§ˆ', 'ì„ìœ ì •ì œ', 'ì—°ë£Œìš©ê°€ìŠ¤', 'ì—°ë£Œì†Œë§¤', 'ì„ìœ ', 'ê°€ìŠ¤',
        'ì—ë„ˆì§€ì¥ë¹„ë°ì„œë¹„ìŠ¤'
    ],
    'Industrials': [
        'ê±´ë¬¼ê±´ì„¤', 'í† ëª©ê±´ì„¤', 'ì‹¤ë‚´ê±´ì¶•', 'ê±´ì¶•ë§ˆë¬´ë¦¬', 'ì „ê¸°ê³µì‚¬', 'í†µì‹ ê³µì‚¬',
        'íŠ¹ìˆ˜ëª©ì ìš©ê¸°ê³„', 'ì¼ë°˜ëª©ì ìš©ê¸°ê³„', 'êµ¬ì¡°ìš©ê¸ˆì†', 'ì „ë™ê¸°', 'ë°œì „ê¸°',
        'ì „ê¸°ë³€í™˜', 'í•­ê³µê¸°', 'ìš°ì£¼ì„ ', 'ì„ ë°•', 'ë³´íŠ¸ê±´ì¡°', 'ì² ë„ì¥ë¹„',
        'ìš´ì†¡ì¥ë¹„', 'ë„ë¡œí™”ë¬¼ìš´ì†¡', 'í•´ìƒìš´ì†¡', 'ìš´ì†¡ê´€ë ¨', 'ê¸°ë°˜ì¡°ì„±',
        'ì‹œì„¤ë¬¼ì¶•ì¡°', 'ê±´ë¬¼ì„¤ë¹„', 'ìœ¡ìƒì—¬ê°ìš´ì†¡', 'í•­ê³µì—¬ê°ìš´ì†¡', 'ìš´ì†¡ì¥ë¹„ì„ëŒ€',
        'ê²½ë¹„', 'ê²½í˜¸', 'íƒì •', 'ì‚¬ì—…ì‹œì„¤ìœ ì§€', 'ì‚°ì—…ìš©ê¸°ê³„', 'ì¦ê¸°', 'ëƒ‰ì˜¨ìˆ˜',
        'ê³µê¸°ì¡°ì ˆ', 'íê¸°ë¬¼ì²˜ë¦¬', 'ê°œì¸ìš©í’ˆìˆ˜ë¦¬', 'ê°€ì •ìš©í’ˆìˆ˜ë¦¬', 'ê±´ì¶•ê¸°ìˆ ',
        'ì—”ì§€ë‹ˆì–´ë§', 'ì „ë¬¸ì„œë¹„ìŠ¤', 'ì‚¬ì—…ì§€ì›', 'êµìœ¡ì§€ì›', 'ì¼ë°˜êµìŠµ', 'êµìœ¡ê¸°ê´€',
        'ì´ˆë“±êµìœ¡', 'ê±´ì¶•ìì¬', 'ì² ë¬¼', 'ë‚œë°©ì¥ì¹˜', 'ì „ë¬¸ë„ë§¤', 'ê¸°ê³„ì¥ë¹„',
        'ì‚°ì—…ìš©ë†ì¶•ì‚°ë¬¼', 'ë™ì‹ë¬¼', 'ì´ì°¨ì „ì§€', 'ì¬ìƒ', 'ì¡°ì„ ', 'ê¸°ê³„', 'ê±´ì„¤',
        'í•­ê³µí™”ë¬¼ìš´ì†¡', 'ë¬¼ë¥˜', 'ìš°ì£¼í•­ê³µ', 'êµ­ë°©', 'ìƒì—…ì„œë¹„ìŠ¤', 'ê³µê¸‰í’ˆ', 'êµìœ¡ì„œë¹„ìŠ¤',
        'ìš´ì†¡ì¸í”„ë¼', 'ë„ë¡œ', 'ì² ë„ìš´ì†¡', 'í•­ê³µì‚¬', 'í•´ìš´ì‚¬',
        'ë³µí•©ê¸°ì—…', 'ë¬´ì—­íšŒì‚¬ì™€íŒë§¤ì—…ì²´'
    ],
    'Materials': [
        'ì² ê°•', 'ë¹„ì² ê¸ˆì†', 'ë¹„ê¸ˆì†ê´‘ë¬¼', 'ìœ ë¦¬', 'ìœ ë¦¬ì œí’ˆ', 'ì‹œë©˜íŠ¸',
        'ì„íšŒ', 'í”Œë¼ìŠ¤í„°', 'ë‚´í™”', 'ìš”ì—…', 'í™”í•™ì œí’ˆ', 'í•©ì„±ê³ ë¬´',
        'í”Œë¼ìŠ¤í‹±ë¬¼ì§ˆ', 'í™”í•™ì„¬ìœ ', 'í”Œë¼ìŠ¤í‹±ì œí’ˆ', 'ê³ ë¬´ì œí’ˆ', 'ê¸ˆì†ê°€ê³µ',
        'ê¸ˆì†ì£¼ì¡°', 'ì¢…ì´', 'íŒì§€ì œí’ˆ', 'ê³¨íŒì§€', 'ì¢…ì´ìƒì', 'ì¢…ì´ìš©ê¸°',
        'í„í”„', 'ë‚˜ë¬´ì œí’ˆ', 'ì œì¬', 'ëª©ì¬ê°€ê³µ', 'ë¬´ê¸°', 'ì´í¬íƒ„',
        'ì„¬ìœ ì œí’ˆì—¼ìƒ‰', 'ì •ë¦¬', 'ë§ˆë¬´ë¦¬ê°€ê³µ', 'ë°©ì ', 'ê°€ê³µì‚¬', 'í¸ì¡°ì›ë‹¨',
        'ì§ë¬¼ì§ì¡°', 'ì§ë¬¼ì œí’ˆ', 'ì¸ì‡„', 'ì¸ì‡„ê´€ë ¨', 'í™”í•™', 'í¬ì¥ì¬',
        'ê±´ì¶•ì œí’ˆ'
    ],
    'Utilities': [
        'ì „ê¸°', 'ì „ê¸°ì¥ë¹„', 'ì ˆì—°ì„ ', 'ì¼€ì´ë¸”', 'ì „êµ¬', 'ì¡°ëª…ì¥ì¹˜',
        'ì „ê¸°ìœ í‹¸ë¦¬í‹°', 'ê°€ìŠ¤ìœ í‹¸ë¦¬í‹°', 'ë³µí•©ìœ í‹¸ë¦¬í‹°', 'ì „ê¸°ì œí’ˆ'
    ],
    'Real Estate': [
        'ë¶€ë™ì‚°'
    ]
}

def map_sector(upjong):
    """ì—…ì¢… â†’ Sector ë§¤í•‘"""
    # NaN ë˜ëŠ” 'N/A' ì²´í¬
    if pd.isna(upjong) or upjong == 'N/A' or str(upjong).strip() == '':
        return 'N/A'
    
    upjong_str = str(upjong).lower()
    
    for sector, keywords in sectors.items():
        for keyword in keywords:
            if keyword.lower() in upjong_str:
                return sector
    
    return 'Other'

df['Sector'] = df['ì—…ì¢…'].apply(map_sector)

# ============================================
# 3. ê²°ê³¼ ì €ì¥ ë° í†µê³„
# ============================================

# ì›ë³¸ ë°±ì—…
backup_path = os.path.join(data_dir, 'kr_stock_sectors_backup.csv')
if not os.path.exists(backup_path):
    df_original = pd.read_csv(file_path, encoding='utf-8-sig')
    df_original.to_csv(backup_path, encoding='utf-8-sig', index=False)
    print(f"\në°±ì—… ìƒì„±: {backup_path}")

# ì €ì¥
df.to_csv(file_path, encoding='utf-8-sig', index=False)
print(f"\nâœ… íŒŒì¼ ì €ì¥ ì™„ë£Œ: {file_path}")

# í†µê³„
print("\n" + "="*60)
print("ğŸ“Š Sector ë¶„í¬")
print("="*60)
sector_counts = df['Sector'].value_counts()
for sector, count in sector_counts.items():
    percentage = (count / len(df)) * 100
    print(f"{sector:30s} {count:4d}ê°œ ({percentage:5.1f}%)")

print(f"\nì´ {len(df)}ê°œ ì¢…ëª©")
print(f"ë§¤í•‘ ì„±ê³µ: {len(df[df['Sector'] != 'N/A'])}ê°œ")
print(f"ë§¤í•‘ ì‹¤íŒ¨ (N/A): {len(df[df['Sector'] == 'N/A'])}ê°œ")
print(f"ê¸°íƒ€ (Other): {len(df[df['Sector'] == 'Other'])}ê°œ")

# N/A ì¢…ëª© ì¶œë ¥
if len(df[df['Sector'] == 'N/A']) > 0:
    print("\nâš ï¸ ë§¤í•‘ë˜ì§€ ì•Šì€ ì¢…ëª© (N/A):")
    print(df[df['Sector'] == 'N/A'][['íšŒì‚¬ëª…', 'ì¢…ëª©ì½”ë“œ', 'ì—…ì¢…']].to_string(index=False))

# Other ì¢…ëª© ì¶œë ¥ (ë§¤í•‘ ê°œì„  í•„ìš”)
if len(df[df['Sector'] == 'Other']) > 0:
    print("\nâš ï¸ 'Other'ë¡œ ë¶„ë¥˜ëœ ì¢…ëª©:")
    print(df[df['Sector'] == 'Other'][['íšŒì‚¬ëª…', 'ì¢…ëª©ì½”ë“œ', 'ì—…ì¢…']].head(10).to_string(index=False))